window.ChefSteps = {}

class ChefSteps.NavigationBootstrap
  constructor: (@headerTarget) ->

  # cssLink: "<link rel=stylesheet type='text/css' href='http://<%= CDN_DOMAIN %>/assets/global_navigation.css' />"

  getHeader: =>
    jQuery.ajax
      url: "http://<%= DOMAIN %>/global-navigation"
      dataType: 'html'
      type: "GET"
      success: @loadHeader

  # loadCSS: =>
  #   jQuery(@cssLink).prependTo('head')

  loadHeader: (response) =>
    jQuery(@headerTarget).html(response)

  fixNavLinks: =>
    jQuery(document).on 'click', 'body .nav a', ->
      top.location = $(this).attr('href')

  bootstrap: =>
    # @loadCSS()
    @getHeader()
    @fixNavLinks()

$ ->
  $(".cleditorButton[title='Insert Image']").attr 'class', 'forum-filepicker'
  filepicker.setKey('<%= ::Rails.application.config.filepicker_rails.api_key %>')
  $(document).on "click", ".forum-filepicker", (event) ->
    event.preventDefault()
    doc = $('.cleditorMain').find('iframe')[0].contentWindow.document

    filepicker.pickAndStore {mimetype:"image/*"}, {location:"S3"}, (fpfiles) =>
      console.log(JSON.stringify(fpfiles))
      url = JSON.stringify(fpfiles[0]['url'])
      convert = "/convert?fit=max&w=400"
      url_with_conversion = JSON.parse(url) + convert
      content = "<img src='" + url_with_conversion + "'/>"
      $(doc).find('body').append(content)