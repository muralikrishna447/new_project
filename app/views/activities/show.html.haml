-################################ HEADER / LAYOUT STUFF ################################

- content_for :title, "#{@activity.title} - #{@activity.activity_type.first}".html_safe
- content_for :description, @activity.description.to_s != "" ? @activity.description.html_safe : @activity.title.html_safe
- content_for :canonical_link, activity_url(@activity) if @activity.id
- content_for :keywords, @activity.tag_list.join(',')
- if @activity.id
  - content_for :facebook_og do
    %meta{property: 'og:url', content: activity_url(@activity)}
    %meta{property: 'og:title', content: @activity.title.html_safe}
    %meta{property: 'og:description', content: @activity.description.to_s != "" ? @activity.description.html_safe : @activity.title.html_safe}
    - if @activity.image_id?
      %meta{property: 'og:image', content: filepicker_activity_hero_image(@activity.image_id)}
    - elsif @activity.featured_image_id?
      %meta{property: 'og:image', content: filepicker_activity_hero_image(@activity.featured_image_id)}
  - content_for :twitter_cards do
    %meta{property: 'twitter:site', content: '@chefsteps'}
    %meta{property: 'twitter:title', content: @activity.title.html_safe }
    %meta{property: 'twitter:description', content: @activity.description}
    - if @activity.image_id?
      %meta{property: 'twitter:image:src', content: filepicker_activity_hero_image(@activity.image_id)}
    - elsif @activity.featured_image_id?
      %meta{property: 'twitter:image:src', content: filepicker_activity_hero_image(@activity.featured_image_id)}
    - if @activity.youtube_id?
      %meta{property: 'twitter:card', content: 'player'}
      %meta{property: 'twitter:player', content: "https://www.youtube.com/embed/#{@activity.youtube_id}?wmode=opaque\&rel=0&modestbranding=1\&showinfo=0"}
      %meta{property: 'twitter:player:height', content: '270'}
      %meta{property: 'twitter:player:width', content: '480'}
    - else
      %meta{property: 'twitter:card', content: 'summary_large_image'}
- @body_tag_attributes = {:'ng-app' => "ChefStepsApp", :'ng-controller' => "ActivityController", :'ng-click' => "bodyClick()", :'ng-init' => "popupEligible = #{@viewed_activities && @viewed_activities.count > 1}" }

-# This is how search engine crawlers know to request the _escaped_fragment_ page
- content_for :ajax_seo do
  %meta{name: "fragment", content: "!"}

-if params[:scaling]
  :javascript
    paramScaling = #{params[:scaling]};


-################################ PRIMARY CONTENT ################################

.banner-image(  ng-controller="BannerController"
                ng-cloak 
                ng-click='toggleHeroVisual()' 
                ng-if="heroMedia.heroDisplayType() != 'none'"
                ng-class="{'hero-video-showing' : showHeroVisual()}")

  .banner-cropper
    %img(ng-src="{{bannerImageURL()}}")  
    .play-button(ng-if="heroMedia.heroDisplayType() == 'video'")
      %i.icon-play-sign    
  .standard-item
    .hero-video.noprint
      = render 'activities/hero_visual'
.banner-spacer( ng-if="heroMedia.heroDisplayType() == 'none'" )

#activity-title(data-activity="#{@activity.title}")
%form(ng-cloak name="activityForm" csfixnakedlinks)

  -# dummy default button so no way a default click on some other button happens when return is pressed in a text field
  %input(ng-click="" type="submit" style="height: 0px !important; width:0px !important; margin-left: -10000px;")

  .container#activity-body.recipe_schema(ng-class="addEditModeClass()"){:itemscope => true, :itemtype => (@activity.is_recipe? ? "http://schema.org/Recipe" : nil), data: {:'activity-id' => @activity.id}}

    .master-column
      #main-content.main-content-container
        %div(ng-switch on="activity.layout_name")
          %div(ng-switch-when='list')
            = render 'shared/activity_layouts/list'
          %div(ng-switch-default)
            = render 'activities/main_activity_content', activity: @activity


    -# Big spinner until the activity loads. By not cloaking but using angular to hide, it
    -# disappears roughly when the page is ready.
    .row.activity-loading-spinner(ng-hide="! loading")
      .span12
        %i.icon-page-load


%div(nell-popup) 

-################################ BOTTOM OF PAGE CONTENT ################################

- content_for :bottom do
  - if ! @minimal
    .row(ng-hide="editMode" ng-cloak)
      .span12
        .section
        %h3 User Creations
        = link_to 'UPLOAD YOUR OWN', '#', class: 'btn btn-primary', data: {toggle: 'modal', target: '#upload-user-creation'}, onclick: "mixpanel.people.set({ 'photo upload intent': '#{@activity.title}' }); mixpanel.track('Photo Upload Intent', { 'photo upload intent': '#{@activity.title}' });"
        #user-creations-carousel
          - if @activity.uploads.approved.any?
            .horizontal-slider{data: {direction: 'right'}}
              .horizontal-slider-wrap
                - @activity.uploads.approved.includes(:user).order('created_at DESC').each do |upload|
                  = render 'shared/media_box', size: 'medium', url: upload_path(upload), title: upload.title, image: upload.image_id
              %div{class: "horizontal-slider-btn-right btn btn-circle"}
                %i{class: "icon-chevron-right"}
              %div{class: "horizontal-slider-shadow-overlay-right"}

    - if (! ENV["CS_NO_SUGGESTED_ACTIVITIES"]) && @popular_recipes && @random_recipes
      .row(ng-hide="editMode" ng-cloak)
        .span12
          %h3 Popular Recipes
          #technique-carousel
            = render 'shared/horizontal_slider', items: @popular_recipes, direction: 'right'

          %h3 From The Archives
          #related-carousel
            = render 'shared/horizontal_slider', items: @random_recipes, direction: 'right'
    - if ! ENV["CS_NO_DISQUS"]
      .row(ng-hide="editMode" ng-cloak)
        .span12
          %h3 Discussion
          .section
            %a#discussion(name='discussion')
            %cscomments(comments-type="activity" comments-id="{{activity.id}}" seo-bot="#{is_brombone}")
            

= content_for :footer do
  = render 'layouts/footer'

= render 'home/madlib_popup', registration_source: 'activityMadlib'


-################################ MODALS  ################################

- if @course
  .modal.hide.fade#syllabus-modal
    .modal-header
      = button_tag "X", class: 'close', data: {dismiss:'modal'}
      %h3= @course.title
    .modal-body
      = course_syllabus(@course)



//////// UPLOAD MODAL /////////
- if params[:action] == 'show'
  .modal.hide.fade#upload-user-creation
    .modal-header
      %h3= "Share your #{@activity.title} creation"
    .modal-body
      = render 'shared/uploads'
  
= render 'cancel_edit_modal'
= render 'restore_autosave.html.haml'
= render 'already_editing_modal.html.haml'

%div(ng-cloak close="showTagsModal = false" modal="showTagsModal" options="modalOptions")
  .modal-header
    %h2 Choose Tags
    Pick all that apply. It is ok to have more than one in a category.
  .modal-body.tag-bg
    %csTagChooser(  ng-model="activity.tags" 
                    options="csTagService.activitySuggestedTags")
  .modal-footer
    %button.btn(ng-click="showTagsModal = false") Done

-################################ PRELOADED JSON FOR SPEED ################################

#preloaded-activity-json.hide
  = @activity.to_json



