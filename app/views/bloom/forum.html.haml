%html
  %head
    %title= "Chefsteps"
    = csrf_meta_tags

    %script(src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js")
    %script(src="//community-staging.usebloom.com/export/loader.js")

    - if current_user
      :javascript
        window.encryptedUser = "#{escape_javascript(current_user.encrypted_bloom_info)}";
        window.chefstepsUserId = "#{current_user.id}"
    - else
      :javascript
        window.chefstepsUserId = null

    %style
      :sass
        $orange: #e25f25

        =boxsizing
          box-sizing: border-box
          -moz-box-sizing: border-box
          -webkit-box-sizing: border-box
          -o-box-sizing: border-box

        =navpadding
          height: 6rem
          padding: 0.8rem
          line-height: 4.4rem

        html
          font-size: 62.5%
          @include boxsizing

        body
          margin: 0px
          font-family: "Helvetica Neue",Helvetica,Arial,sans-serif
          font-size: 14px
          line-height: 1.42857143
          color: #333
          background-color: #fff

        .cs-nav
          position: relative
          text-align: center
          display: block
          background: rgba(255,255,255,0.9)
          width: 100%
          z-index: 9999
          border-bottom: 2px solid #ccc
          border-top: 2px solid $orange
          height: 6rem
          left: 0px
          ::selection
            background: none
            color: $orange

          h3
            margin-top: 15px
            margin-bottom: 15px
            font-size: 24px
            font-weight: 500
            line-height: 1.1

        .cs-nav-logo
          position: absolute
          height: 100%
          padding: 0.8rem
          float: left
          @include boxsizing
          img
            height: 100%

        .cs-nav-profile
          position: absolute
          top: 0px
          right: 0px
          @include boxsizing
          @include navpadding
  %body
    .cs-nav
      .cs-nav-logo
        %a(href='/')
          %img(src="https://s3.amazonaws.com/uploads.hipchat.com/45918/740320/PBNf6MFq9hsgnF1/csLogoHorizontalSmall-2014.05.02.svg")
      %h3 Welcome to the ChefSteps Forum
      .cs-nav-profile
        - if current_user
          = link_to user_profile_url(current_user) do
            %span
              = image_tag filepicker_arbitrary_image(current_user.profile_image_id, 75)
        - else
          sign in
    .forum
    :javascript
      Bloom.configure({
        env: 'staging',
        apiKey: 'xchefsteps',
        user: window.chefstepsUserId,
        auth: window.encryptedUser,
        getUsers: function(userIds, callback) {
          $.getJSON('/users?emails=' + userIds).then(function(response){
            var users;
            console.log(response);
            users = response.map(function(user) {
              user._id = "" + user.id;
              user.profileLink = "http://www.chefsteps.com/profiles/" + user.slug;
              user.avatarUrl = user['avatar_url'];
              return user;
            });
            return callback(users);
          });
        }
      });
      Bloom.installForum({
        el: $('.forum')[0]
      });