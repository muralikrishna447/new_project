- content_for :title, "Poll - #{@poll.title.html_safe}"
- content_for :description, @poll.description != "" ? @poll.description.html_safe : @poll.title.html_safe
- content_for :canonical_link, poll_url(@poll) if @poll.id
- content_for :keywords, @poll.poll_items.map(&:title).join(',')

- content_for :facebook_og do
  %meta{property: 'og:url', content: poll_url(@poll)}
  %meta{property: 'og:title', content: @poll.title.html_safe}
  %meta{property: 'og:description', content: @poll.description != "" ? @poll.description.html_safe : @poll.title.html_safe}
  %meta{property: 'og:image', content: s3_image_url(Setting.footer_image)}
- require 'ostruct'

.container.section#poll{data: {:'poll-id' => "#{@poll.id}"}}
  .row
    .span12(ng-controller='VotesController' ng-cloak)
      - if current_user
        - current_user_votes = current_user.votes.scoped_by_type('PollItem').map(&:votable_id)
      - else
        - current_user_votes = false
      %span(ng-model="current_user_votes" ng-init="current_user_votes=#{current_user_votes}")
      .poll-header-block
        .poll-header
          %h1
            {{poll.title}}
          %p
            {{poll.description}}
        .poll-header-votes
          .poll-header-votes-border
            .poll-header-votes-count
              = @poll.poll_items.map(&:votes_count).inject(:+)
            .poll-header-votes-text
              Votes
              .poll-header-votes-subtext
                and counting...

      %div(ng-repeat="poll_item in poll.poll_items | orderBy:'-votes_count'" ng-cloak ng-controller="PollItemController" ng-animate="'custom'")
        .poll-item
          .poll-item-vote-up{onclick: "mixpanel.track('Poll Voted', {'Poll Item': {{poll_item.id}} });"}
            %span(ng-switch on="current_user_voted_for_this(poll_item)")
              %span(ng-switch-when='true')
                .poll-item-btn.poll-item-btn-voted(ng-click="unvoteObject()")
                  %i.icon-angle-up
                  .poll-item-vote-count
                    {{poll_item.votes_count}}
              %span(ng-switch-when='false')
                .poll-item-btn(ng-click="voteObject()" tooltip="Vote for this")
                  %i.icon-angle-up
                  .poll-item-vote-count(ng-show='current_user_voted()')
                    {{poll_item.votes_count}}

          .poll-item-text
            %a.poll-item-details-btn(ng-click='pollItemDetails(poll_item)')
              %h3 {{poll_item.title}}
              %p.black-link {{poll_item.description}}
            .poll-item-user-voted(ng-show='current_user_voted_for_this(poll_item)')
              You voted for this!
            .poll-item-voters(ng-show='current_user_voted()')
              %div(ng-repeat='voter in poll_item.users')
                .poll-item-voter
                  %a(href="/profiles/{{voter.slug}}")
                    %img(ng-src="{{userImageUrl(voter.image_id)}}")
                  .poll-item-voter-tooltip
                    {{voter.name}}
            .section.social-group
              %a.btn.btn-primary.btn-poll-comments(ng-click='mixpanel.track("Poll View Comments"); pollItemDetails(poll_item)')
                %ng-pluralize(count="poll_item.comments_count" when="{'0': 'Be the first to comment', 'one': '1 comment', 'other': '{} comments'}")
              = render 'layouts/share_button', split_name: ''
            %div(collapse='!poll_item.show_details')
              %div(ng-controller='CommentsController' ng-init="init('poll_items',poll_item.id)" ng-cloak)
                = render 'comments/comments', commentable: nil
              / = render 'comments/comments', commentable: @poll

      %div.voting-spinner(ng-hide="hideSpinner")
        %i.icon-spinner.icon-spin.icon-large

= render 'layouts/footer'

:javascript
  mixpanel.track('Poll Viewed', {'poll' : "#{@poll.title}", 'url' : window.location.pathname});                
