-# Note! Really important to use class_url, not class_path, so we get off SSL after purchase.
-# This way of using ng_init is ugly, need to come up with a better plan. One way
-# would be to retrieve this info via a resource (which could be pre-rendered like)
-# we do for activity show view.

.buy-buttons(ng-controller="BuyAssemblyStripeController"
              ng-cloak
              ng-init='assembly=#{assembly.to_json}; discounted_price=#{@discounted_price}; logged_in=#{current_user != nil}; enrolled=#{enrolled ? true : false}; assemblyPath="#{class_url(assembly, protocol: "http")}"; completed="#{completed ? true : false}"; lastViewedActivity="#{current_user ? class_activity_path(assembly, current_user.last_viewed_activity_in_assembly(assembly)) : nil}"; gift_certificate=#{gift_certificate.to_json}; rails_env="#{Rails.env}"; split_name="#{@split_name}"' )

  -#
  -# Primary CTA
  -#
  %div(ng-show="(! logged_in && assembly.price)")
    .login(ng-controller="LoginController")
      .btn.btn-primary.btn-large.input-block-level#sign-in-and-buy-button(ng-click="waitForLogin(); openModal()")
        BUY NOW
        = render 'activities/latest/assembly_price'
        = render "devise/sessions/new_angular"

  -# Already enrolled
  %div(ng-show="enrolled")
    .main-cta
      %div(ng-hide='completed')
        %a.btn.btn-primary.btn-large.input-block-level#continue-button(ng-href="{{lastViewedActivity || assemblyPath}}")
          %span Continue Class

      %div(ng-show='completed')
        %a.btn.btn-primary.btn-large.input-block-level#completed-button(ng-href="{{assemblyPath}}")
          %span View Class

  -# Not logged in but gift certificate available
  %div(ng-show="gift_certificate && (! enrolled) && assembly.price && ! logged_in")
    .main-cta(ng-controller="LoginController")
      .btn.btn-primary.btn-large.input-block-level#sign-in-and-redeem-gift-button(ng-click="waitForRedemption(); openModal()")
        Get My Gift
        = render "devise/sessions/new_angular"

  -# Not enrolled, paid class, gift certificate available
  %div(ng-show="gift_certificate && (! enrolled) && assembly.price && logged_in")
    .main-cta
      .btn.btn-primary.btn-large.input-block-level#redeem-gift-button(ng-click="redeemGift()")
        Get My Gift

  -# Not enrolled, paid class
  %div(ng-show="(! gift_certificate) && (! enrolled) && assembly.price && logged_in")
    .main-cta
      .btn.btn-primary.btn-large.input-block-level#buy-button(ng-click="openModal(false)")
        BUY NOW
        = render 'activities/latest/assembly_price'

  -# Not enrolled, free class
  %div(ng-show="(! gift_certificate) && (! enrolled) && (discounted_price == '0')")
    %div(ng-show="(! logged_in)")
      .login(ng-controller="LoginController")
        .btn.btn-primary.btn-large.input-block-level#sign-in-and-enroll-free-button(ng-click="waitForFreeEnrollment(); openModal()")
          Enroll for Free
          = render "devise/sessions/new_angular"
    .main-cta(ng-show="(logged_in)")
      .btn.btn-primary.btn-large.input-block-level#enroll-free-button(ng-click="free_enrollment()")
        Enroll For Free

  -#
  -# Secondary CTA
  -#

  -# Sell gift certificate
  -# Not Logged in but want to buy gift certificate
  %div(ng-show="(! gift_certificate) && (assembly.price > 0) && ! logged_in")
    .gift-cta(ng-controller="LoginController")
      .btn.btn-secondary.btn-large.input-block-level#sign-in-and-gift-button(ng-click="waitForLogin(); buyingGift(); openModal()")
        Send As Gift
        %div.inline(ng-show="enrolled")
          = render 'activities/latest/assembly_price'
          = render "devise/sessions/new_angular"

  -# Logged In
  %div(ng-show="(! gift_certificate) && (assembly.price > 0) && logged_in")
    .gift-cta
      .btn.btn-secondary.btn-large.input-block-level#gift-button(ng-click="openModal(true)")
        Send As Gift
        %div.inline(ng-show="enrolled")
          = render 'activities/latest/assembly_price'


  =render 'buy_modal'